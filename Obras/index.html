<!DOCTYPE html>
<html>
  <head>
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
    <![endif]-->

    <link rel="stylesheet/less" href="less/bootstrap.less">

    





    <link rel="stylesheet" href="css/style.css" />

    <script src="js/less.js"></script>
   

    

    <link rel="stylesheet" href="http://addyosmani.github.com/jquery-ui-bootstrap/css/custom-theme/jquery-ui-1.8.16.custom.css" />

    <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
    <script>less.watch();</script>

  </head>
    
  <body>



<div class="navbar-fixed-top">
  <div class="header-gcba">
    <div class="header-inner">
      <div class="container-fluid">
      <div id="logo"></div>
        <h2 class="slogan">En todo estás vos</h2>
      </div>
    </div>
  </div>
</div>

<div class="nav-float">

<!--

########################

FILTRAR OBRAS POR TIEMPO

slider id: slider-range
calendar pick id 1: datePickerStart
calendar pick id 2: datePickerEnd

########################

-->

  <div class="row">
    <div class="span3">
      <h3>Filtrar obras por tiempo</h3>
      <div id="slider-range"></div>
    </div>
  </div>

  <div class="row">
    <div class="span5">
      <h4>Fecha inicial</h4><input type="text" id="datePickerStart" />
      <h4>Fecha final</h4><input type="text" id="datePickerEnd" />
    </div>
  </div>


<!--

########################

FILTRAR POR TIPO DE OBRA
ID: radioset-tipo

########################

-->

  <div class="row">
    <div class="span5">
      <h3>Filtrar por tipo de obra</h3>
      <div id="radioset-tipo" class="ui-buttonset">

        <input type="radio" id="radio1" name="radio" class="ui-helper-hidden-accessible"><label for="radio1" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-left" role="button" aria-disabled="false"><span class="ui-button-text">Calle</span></label>

        

        <input type="radio" id="radio3" name="radio" class="ui-helper-hidden-accessible"><label for="radio3" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-right" role="button" aria-disabled="false"><span class="ui-button-text">Vereda</span></label>

        <input type="radio" id="radio2" name="radio" checked="checked" class="ui-helper-hidden-accessible"><label for="radio2" class="ui-button ui-widget ui-state-default ui-button-text-only ui-state-active" aria-pressed="true" role="button" aria-disabled="false"><span class="ui-button-text">Todas las obras</span></label>

      </div>
    </div>
  </div>

<!--

##########################

FILTRAR POR ESTADO DE OBRA
ID: radioset-estado

##########################

-->


  <div class="row">
    <div class="span6">
      <h3>Filtrar por estado de obra</h3>
      <div id="radioset-estado" class="ui-buttonset">

        <input type="radio" id="radio1" name="radio" class="ui-helper-hidden-accessible"><label for="radio1" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-left" role="button" aria-disabled="false"><span class="ui-button-text">Iniciado</span></label>

        

        <input type="radio" id="tipo-ejec" name="radio" class="ui-helper-hidden-accessible"><label for="tipo-ejec" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-right" role="button" aria-disabled="false"><span class="ui-button-text">Ejecutado</span></label>

        <input type="radio" id="tipo-inic" name="radio" class="ui-helper-hidden-accessible"><label for="tipo-inic" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-button-text-only ui-corner-right" role="button" aria-disabled="false"><span class="ui-button-text">Verificados</span></label>

        <input type="radio" id="tipo-all" name="radio" checked="checked" class="ui-helper-hidden-accessible"><label for="tipo-all" class="ui-button ui-widget ui-state-default ui-button-text-only ui-state-active" aria-pressed="true" role="button" aria-disabled="false"><span class="ui-button-text">Todas las obras</span></label>
        
      </div>
    </div>
  </div>


<!--

##########################

FILTRAR POR COMUNAS
ID: radioset-estado

##########################

-->


  <div class="row">
    <div class="span6">
      <h3>Zoom por comunas</h3>
         
          <div class="btn-group">
            <button class="btn btn-primary">Seleccionar comuna</button>
            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li id="comuna-1"><a href="#">Comuna 1<br /><small>Retiro, San Nicolás, Puerto Madero, San Telmo, Montserrat y Constitución.</small></a></li>
              <li id="comuna-2"><a href="#">Comuna 2<br /><small>Recoleta.</small></a></li>
              <li id="comuna-3"><a href="#">Comuna 3<br /><small>Balvanera y San Cristóbal.</small></a></li>
              <li id="comuna-4"><a href="#">Comuna 4<br /><small>La Boca, Barracas, Parque Patricios, y Nueva Pompeya.</small></a></li>
              <li id="comuna-5"><a href="#">Comuna 5<br /><small>Almagro y Boedo.</small></a></li>
              <li id="comuna-6"><a href="#">Comuna 6<br /><small>Caballito.</small></a></li>
              <li id="comuna-7"><a href="#">Comuna 7<br /><small>Flores y Parque Chacabuco.</small></a></li>
              <li id="comuna-8"><a href="#">Comuna 8<br /><small>Villa Soldati, Villa Riachuelo y Villa Lugano.</small></a></li>
              <li id="comuna-9"><a href="#">Comuna 9<br /><small>Liniers, Mataderos y Parque Avellaneda.</small></a></li>
              <li id="comuna-10"><a href="#">Comuna 10<br /><small>Villa Real, Monte Castro, Versalles, Floresta, Vélez Sarsfield y Villa Luro.</small></a></li>
              <li id="comuna-11"><a href="#">Comuna 11<br /><small>Villa General Mitre, Villa Devoto, Villa del Parque y Villa Santa Rita.</small></a></li>
              <li id="comuna-12"><a href="#">Comuna 12<br /><small>Coghlan, Saavedra, Villa Urquiza y Villa Pueyrredón.</small></a></li>
              <li id="comuna-13"><a href="#">Comuna 13<br /><small>Núñez, Belgrano y Colegiales.</small></a></li>
              <li id="comuna-14"><a href="#">Comuna 14<br /><small>Palermo.</small></a></li>
              <li id="comuna-15"><a href="#">Comuna 15<br /><small>Chacarita, Villa Crespo, La Paternal, Villa Ortúzar, Agronomía y Parque Chas.</small></a></li>
            </ul>
          </div>

    </div>
  </div>



</div>

<div id="map"></div>




<div class="navbar navbar-fixed-bottom">
<div class="navbar-inner">
<div class="container-fluid">
<div class="row-fluid">
<div class="span3"><h1 class="brand" href="#">Plan de Obras 2013, GCBA</h1></div>


</div>
  </body>


  <!-- include cartodb.js library -->
  <script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script>
  <script>
    var myLayer
    function main() {

      var map = L.map('map', { 
        zoomControl: false,
        center: [-34.618234674892, -58.404178619384766],
        zoom: 12
      })

      // add a nice baselayer from mapbox
      L.tileLayer('http://a.tiles.mapbox.com/v3/pixelbeat.map-pet5vndu/{z}/{x}/{y}.png', {
        attribution: 'MapBox'
      }).addTo(map);

      cartodb.createLayer(map, 'http://gcbadata.cartodb.com/api/v1/viz/16866/viz.json', {
        query: 'select * from {{table_name}}'

      })
       .on('done', function(layer) {
        map.addLayer(layer);
        myLayer = layer;
        setSlider();


        layer.on('featureOver', function(e, pos, latlng, data) {
          cartodb.log.log(e, pos, latlng, data);
        });

        layer.on('error', function(err) {
          cartodb.log.log('error: ' + err);
        });

      }).on('error', function() {
        cartodb.log.log("some error occurred");
      });



    }

    // you could use $(window).load(main);
    window.onload = main;


    function setSlider() {

    var sql = new cartodb.SQL({ user: 'gcbadata' });
      sql.execute("SELECT MIN (START_TS) FROM plan_de_obras")
        .done(function(data) {
          var timeFirst = new Date(Date.parse(data.rows[0].min));
          initSlider(timeFirst)
        })
        .error(function(errors) {
          // errors contains a list of errors
          console.log("error:" + err);
        })

    }

    function updateMap(firstDate, lastDate) {
      sql = "select * from " + myLayer.options.table_name + " where end_ts < '" + lastDate.toUTCString() + "' and start_ts > '" + firstDate.toUTCString() +"'"
          console.log("sql: " +  sql)
          myLayer.setQuery( sql)
    }

    function updatePickers(firstDate, lastDate){
      $( "#datePickerStart" ).datepicker( "setDate", firstDate);
      $( "#datePickerEnd" ).datepicker( "setDate", lastDate);
    }

    function updateSlider(minDate) {
      one_day = 1000*60*60*24
      $("#slider-range").slider("values", 0, Math.ceil((new Date(firstDate) - minDate)/one_day))
      $("#slider-range").slider("values", 1, Math.ceil((new Date(lastDate) - minDate)/one_day))
    }

    function initSlider(minDate, max_days) {
      var one_day = 1000*60*60*24;
      var timeNow = new Date();
      var max_days = Math.ceil((timeNow-minDate)/one_day)
  
      $( "#datePickerStart" ).datepicker({ defaultDate: -max_days, minDate: -max_days, maxDate: 0});
      $( "#datePickerStart" ).datepicker( "setDate", minDate);

      $("#datePickerStart").change(function(eventData) {
        firstDate = $("#datePickerStart").datepicker("getDate");
        lastDate = $("#datePickerEnd").datepicker("getDate")
        updateSlider(minDate, firstDate, lastDate );
        updateMap(firstDate, lastDate);
      });


      $( "#datePickerEnd" ).datepicker({ defaultDate: 0, minDate: -max_days, maxDate: 0});
      $( "#datePickerEnd" ).datepicker( "setDate", timeNow);

      $("#datePickerEnd").change(function(eventData) {
        firstDate = $("#datePickerStart").datepicker("getDate");
        lastDate = $("#datePickerEnd").datepicker("getDate")
        updateSlider(minDate, firstDate, lastDate );
        updateMap(firstDate, lastDate);
      });

      $('#radioset-tipo').buttonset();
      $('#radioset-estado').buttonset();


      $( "#slider-range" ).slider({
        range: true,
        min: 0,
        max: max_days,
        values: [ 0, max_days ],
        slide: function(event, ui) {
          setMinDate = new Date(minDate.getTime() + ui.values[0]*24*60*60*1000);
          setMaxDate = new Date(minDate.getTime() + ui.values[1]*24*60*60*1000);
          updatePickers(setMinDate, setMaxDate)
        },
        stop: function( event, ui ) {
          setMinDate = new Date(minDate.getTime() + ui.values[0]*24*60*60*1000);
          setMaxDate = new Date(minDate.getTime() + ui.values[1]*24*60*60*1000);
          updateMap(setMinDate, setMaxDate)
        }
      });
      //$("#amount").val( "$" + $( "#slider-range" ).slider( "values", 0 ) + " - $" + $( "#slider-range" ).slider( "values", 1 ) );
    }


  </script>


</html>
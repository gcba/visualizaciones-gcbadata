<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
  <![endif]-->
  <link rel="stylesheet" href="css/bootstrap.css" />


  <script src="js/jquery-2.0.3.min.js"></script>

  <script src="js/jquery.flexslider.min.js"></script>

  <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>


  <link rel="stylesheet" href="css/style.css" />
  <script type="banner/html" id="banner_template">

    <div class="banner">
      <div class="container">

        <div class="jumbotron">
          <div class="flexslider">
            <ul class="slides">
              <li class="slide-inicial">
                <h1>Primera semana del Sistema de Inscripción Escolar</h1>
                <h4>Visualizamos los datos de las 40.000 inscripciones para el ciclo lectivo 2014</h4>

              </li>
              <li class="slide-mapa">
                <h1>Para explorar, primero seleccioná un nivel</h1>
                <h3></h3>
                <select name="nivel" id="menu-nivel">
                  <option>Seleccioná para comenzar</option>
                  <option value="1">Inicial</option>
                  <option value="2">Primario</option>
                  <option value="3">Secundario</option>
                  <option value="4">Terciario</option>
                </select>
              </li>
              <li class="slide-herramientas">
                <h1>Seleccionaste el nivel</h1>
                <h3 id="nivel"></h3>
                <select name="modalidad" id="menu-modalidad">
                  <option>Especial</option>
                  <option>Inicial</option>
                  <option>Escuelas Normales Superiores (ENS)</option>
                  <option>Primario</option>
                  <option>Adultos</option>
                  <option>Artística</option>
                  <option>Bachiller</option>
                  <option>Comercial</option>
                  <option>Técnica</option>
                  <option>Terciario<option>
                  <option>IFTS<option>
                </select>
              </li>
              <li class="slide-herramientas">
                  <h1>Titulo de slide.</h1>
                  <h3></h3>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </script>
  <script>

    var mainMap;
    var mainLayer;

    function init() {

    

    $('#banner-container').html($('#banner_template').html());

    var $nivel = $('select[name=nivel]');
    var $modalidad = $('select[name=modalidad]');
    var nivelSeleccionado;

    selectors();

    var closeBanner = function() {

      
      $('#banner-container').empty();
      $('#banner-container').html($('#banner_template').html());
      
      var banner = $('.banner');
      banner.removeClass('banner');
      banner.addClass('banner-aside');

      

      $nivel = $('select[name=nivel]');
      $modalidad = $('select[name=modalidad]');

      selectors();

      $('.flexslider').flexslider({
        slideshow: false,
        startAt: 2
      });
      
    }

      mainMap = new L.Map('map', { 
        center: [-34.60573136549312, -58.4307861328125],
        zoom: 13
      })

      L.tileLayer('https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png', {
        attribution: 'Mapbox <a href="http://mapbox.com/about/maps" target="_blank">Terms &amp; Feedback</a>'
      }).addTo(mainMap);

      var layerUrl = 'http://gcba.cartodb.com/api/v2/viz/4812766e-47ee-11e3-9b00-3085a9a956e8/viz.json';

      var sublayers = [];

      function updateQuery() {

        sublayers[0].set({
          sql: "SELECT * FROM mapa_escuelas_con_registros WHERE nivel_desc IN ('"+nivelSeleccionado+"')",
          cartocss: "#mapa_escuelas_con_registros{marker-fill: #ff5c00;marker-line-color: #ffffff;marker-line-width: 0;marker-line-opacity: 0;marker-opacity: 0.9;marker-placement: point;marker-type: ellipse;marker-allow-overlap: false;marker-clip: false;marker-multi-policy: largest;}#mapa_escuelas_con_registros [total_inscriptos > 200] { marker-width: 30;}#mapa_escuelas_con_registros [total_inscriptos <= 150] { marker-width: 25;}#mapa_escuelas_con_registros [total_inscriptos <= 50] { marker-width: 10;}#mapa_escuelas_con_registros [total_inscriptos <= 10] { marker-width: 5.0;}"

        });
        closeBanner();
      }

      function updateQuerywithMods() {
        sublayers[0].set({
          sql: "SELECT * FROM mapa_escuelas_con_registros WHERE nivel_desc IN ('"+nivelSeleccionado+"') AND modalidad_desc IN ('"+$modalidadSeleccionada+"')"
        });

        console.log("SELECT * FROM mapa_escuelas_con_registros WHERE nivel_desc IN ('"+nivelSeleccionado+"') modalidad_desc IN ('"+$modalidadSeleccionada+"')");
      }

      cartodb.createLayer(mainMap, layerUrl)
        .addTo(mainMap)
        .on('done', function(layer) {
          mainMap.addLayer(layer);
          mainLayer = layer;
          var subLayerOptions = {
            sql: "SELECT * FROM mapa_escuelas_con_registros",
            cartocss: "#mapa_escuelas_con_registros{marker-fill: #ffffff;marker-line-color: #ffffff;marker-line-width: 3;marker-line-opacity: 0.5;marker-opacity: 0.5;marker-placement: point;marker-type: ellipse;marker-allow-overlap: false;marker-clip: false;marker-multi-policy: largest;}#mapa_escuelas_con_registros [total_inscriptos > 200] { marker-width: 30;}#mapa_escuelas_con_registros [total_inscriptos <= 150] { marker-width: 25;}#mapa_escuelas_con_registros [total_inscriptos <= 50] { marker-width: 10;}#mapa_escuelas_con_registros [total_inscriptos <= 10] { marker-width: 5.0;}"
              }

          var sublayer = layer.getSubLayer(0);

          sublayer.set(subLayerOptions);

          sublayers.push(sublayer);
        }).on('error', function() {
          //log the error
        });

      /*
      $('.button').click(function() {
        $('.button').removeClass('selected');
        $(this).addClass('selected');
        LayerActions[$(this).attr('id')]();
      });
*/


/*
      $('.button').click(function() {
        $('.button').removeClass('selected'); $(this).addClass('selected');
        nivelSeleccionado = $(this).attr('id');
        modalidadSeleccionada = 
        updateQuery();
      });*/

      $('.flexslider').flexslider({
        animation: "slide",
        pauseOnHover: true,
        startAt: 0,
        slideshow: false
      });

      function selectors() {
        //$modalidad.hide();

        var $modalidadLista = $modalidad.find('option').clone();

        var nivelesMasModalidades = {
            Inicial: ["Escuelas Normales Superiores (ENS)","Especial","Inicial"],
            Primario: ["Escuelas Normales Superiores (ENS)", "Primario"],
            Secundario: ["Adultos", "Artística", "Bachiller", "Comercial", "Escuelas Normales Superiores (ENS)","Técnica"],
            Terciario: ["Terciario", "IFTS"]
        }

        $nivel.change(function () {
            nivelSeleccionado = $(this).find('option:selected').text();
            $modalidad.show();
            updateQuery();
            console.log(nivelSeleccionado);
            $modalidad.html($modalidadLista.filter(function () {
                 return $.inArray($(this).text(), nivelesMasModalidades[nivelSeleccionado]) >= 0;
            }));
        });

        $modalidad.change(function () {
            //nivelSeleccionado = $nivel.find('option:selected').text()
            // Crear un flag para avisarle a updateQuery que existe un parámetro de modalidad seleccionado.
            $modalidadSeleccionada = $(this).find('option:selected').text();
            updateQuerywithMods();
            console.log(nivelSeleccionado);
        });

      }




    }

    



  </script>

    <script type="text/javascript">
 

    </script>
</head>

<body onload="init()">
<header class="navbar-fixed-top">
  <div class="navbar">
      <div class="header-gcba">
          <div class="header-inner">
            <div class="container">
              <a href="http://buenosaires.gob.ar" target="_blank"><div class="logo"></div></a>
              <h2 class="slogan">En todo estás vos</h2>
            </div>
          </div>
      </div>
  </div>     
</header>
<div id="charts"></div>
<div id="banner-container"></div>
<div id='map'></div>
</body>
</html>